#!groovy

int rollbackNum = "${RollbackFrom}" as Integer
boolean pulledFrom97 = false

stage('Setup') {
  node('AWS') {
    echo "Rolling back from stage ${RollbackFrom}"
  }
}

stage('Mandel Deploy Stage 2') {
  node('97') {
    if(!pulledFrom97) {
      // TODO: Pull files from .97 and stash for this build
      pulledFrom97 = true
    }
  }
  node('AWS') {
    if(rollbackNum >= 7) {
      // TODO: Need to pull from .97 to get backup files
    } else {
      echo 'Skipping this rollback because of given RollbackFrom value'
    }
  }
}

stage('Trace Deploy Stage 2') {
  node('AWS') {
    if(rollbackNum >= 6) {
      build job: 'Trace_Rollback_Staged', parameters: [string(name: 'City', value: "${City}"), string(name: 'Deploy_Env', value: "${Deploy_Env}"), string(name: 'Stage', value: "2")]
    } else {
      echo 'Skipping this rollback because of given RollbackFrom value'
    }
  }
}

stage('Dynamob Deployment') {
  node('97') {
    if(!pulledFrom97) {
      // TODO: Pull files from .97 and stash for this build
      pulledFrom97 = true
    }
  }
  node('master') {
    if(rollbackNum >= 5) {
      // TODO: Need to pull from .97 to get backup files
    } else {
      echo 'Skipping this rollback because of given RollbackFrom value'
    }
  }
}

stage('Parade 1.0/1.5.1 Deployment') {
  node('97') {
    if(!pulledFrom97) {
      // TODO: Pull files from .97 and stash for this build
      pulledFrom97 = true
    }
  }
  node('AWS') {
    if(rollbackNum >= 4) {
      parallel 'Parade 1.0 Deployment':{
        if("${Parade_Version}".compareTo("1.0")==0 || "${Parade_Version}".compareTo("All")==0) {
          build job: 'Parade_1.0_Rollback', parameters: [string(name: 'City', value: "${City}"), string(name: 'Deploy_Env', value: "${Deploy_Env}")]
        }
      }, 'Parade 1.5.1 Deployment': {
        if("${Parade_Version}".compareTo("1.5.1")==0 || "${Parade_Version}".compareTo("All")==0) {
          // TODO: Need to pull from 97 to get backup files
        }
      }
    } else {
      echo 'Skipping this rollback because of given RollbackFrom value'
    }
  }
}

stage('Mandel/WaitTimeModel/Map Matching Deployment') {
  node('97') {
    if(!pulledFrom97) {
      // TODO: Pull files from .97 and stash for this build
      pulledFrom97 = true
    }
  }
  node('AWS') {
    if(rollbackNum >= 3) {
      parallel 'Mandel Deployment': {
        // TODO: Need to pull from .97 to get backup files
      }, 'WaitTimeModel Deployment': {
        if("${City}".compareTo("elpaso_juarez")==0) {
          // TODO: Need to pull from .97 to get backup files
        }
      }, 'Map Matching Deployment': {
        // TODO: Need to pull from .97 to get backup files
      }
    } else {
      echo 'Skipping this rollback because of the given RollbackFrom value'
    }
  }
}

stage('Trace/Crystal/Navigator Deployment') {
  node('AWS') {
    if(rollbackNum >= 2) {
      parallel 'Trace Deployment':{
        build job: 'Trace_Rollback_Staged', parameters: [string(name: 'City', value: "${City}"), string(name: 'Deploy_Env', value: "${Deploy_Env}"), string(name: 'Stage', value: "1")]
      }, 'Crystal Deployment':{
        build job: 'Crystal_Rollback', parameters: [string(name: 'City', value: "${City}"), string(name: 'Deploy_Env', value: "${Deploy_Env}")]
      }, 'Navigator Deployment':{
        build job: 'Navigator_Rollback', parameters: [string(name: 'City', value: "${City}"), string(name: 'Deploy_Env', value: "${Deploy_Env}")]
      }
    } else {
      echo 'Skipping this rollback because of the given RollbackFrom value'
    }
  }
}

stage('FFS Deployment') {
  node('AWS') {
    if(rollbackNum >= 1) {
      build job: 'FFS_Rollback', parameters: [string(name: 'City', value: "${City}"), string(name: 'Deploy_Env', value: "${Deploy_Env}")]
    } else {
      echo 'Skipping this rollback because of the given RollbackFrom value'
    }
  }
}
